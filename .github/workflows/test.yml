name: Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  release:
    types: [created]

jobs:
  test-cli:
    name: Test CLI
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [16.x, 17.x, 18.x]
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Prepare PNPM
        uses: ./.github/actions/prepare-pnpm
        with:
          node-version: ${{ matrix.node-version }}
      - name: Test CLI
        run: pnpm --filter @hahnpro/flow-cli test
        env:
          NODE_OPTIONS: '--experimental-vm-modules'
  test-sdk:
    name: Test SDK
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [16.x, 17.x, 18.x]
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Prepare PNPM
        uses: ./.github/actions/prepare-pnpm
        with:
          node-version: ${{ matrix.node-version }}
      - name: Test SDK
        run: pnpm test packages/sdk -- --testPathIgnorePatterns rpc.spec.ts sidrive.spec.ts
  test-api:
    name: Test API
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [16.x, 17.x, 18.x]
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Prepare PNPM
        uses: ./.github/actions/prepare-pnpm
        with:
          node-version: ${{ matrix.node-version }}
      - name: Test API
        run: pnpm test packages/api -- --testPathIgnorePatterns api.spec.ts
  test-examples:
    name: Test Examples
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [ 3.7.x, 3.8.x, 3.9.x, 3.10.x ]
    services:
      rabbitmq:
        image: rabbitmq:3.10
        ports:
          - 5672:5672
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install Python dependencies
        run: pip install aio_pika
      - name: Prepare PNPM
        uses: ./.github/actions/prepare-pnpm
      - name: Activate Post Build Hooks
        run: pnpm config set enable-pre-post-scripts true
      - name: Build API & SDK
        run: pnpm --filter @hahnpro/hpc-api --filter @hahnpro/flow-sdk build
      - name: Test Examples
        run: pnpm --filter flow-module-examples test all
